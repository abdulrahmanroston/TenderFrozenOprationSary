<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#1a73e8">

    <!-- Page Title -->
    <title>Frozen Products</title>

    <!-- Manifest for PWA -->
    <!-- <link rel="manifest" href="manifest.json"> -->

    <!-- External Stylesheets -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="tf-navigation.css">

    <!-- Internal Styles -->
    <style>
        :root {
            --primary: #1a73e8;
            --secondary: #f4f6f8;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #16a34a;
            --background: #f9fafb;
            --card-bg: #ffffff;
            --text: #1f2937;
            --border: #d1d5db;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --out-of-stock-bg: rgba(255, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 500;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--warning);
            color: #fff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s, background 0.3s;
        }

        .fab:hover {
            transform: scale(1.1);
            background: #d97706;
        }

        .menu-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .menu-modal.active {
            display: flex;
            opacity: 1;
        }

        .menu-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 300px;
            box-shadow: var(--shadow);
        }

        .menu-content h2 {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .menu-content ul {
            list-style: none;
        }

        .menu-content ul li {
            padding: 12px;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-content ul li:hover, .menu-content ul li.active {
            background: var(--secondary);
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-bar input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            min-width: 200px;
            font-family: 'Roboto', sans-serif;
        }

        .filter-bar input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(37, 99, 235, 0.3);
            outline: none;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: thin;
        }

        .filter-tabs button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: var(--secondary);
            color: var(--text);
            cursor: pointer;
            font-weight: 500;
            font-family: 'Roboto', sans-serif;
            transition: background 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-tabs button.active, .filter-tabs button:hover {
            background: var(--primary);
            color: #fff;
        }

        .category-section {
            margin-bottom: 30px;
        }

        .category-section h2 {
            width: 100%;
            font-size: 1.6rem;
            color: var(--primary);
            margin: 25px auto;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
            text-align: center;
        }

        .product-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .product-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
            width: calc(25% - 15px);
            position: relative;
        }

        .product-card.out-of-stock {
            background: var(--out-of-stock-bg);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--secondary);
        }

        .product-card h3 {
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 8px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Roboto', sans-serif;
        }

        .product-card .price {
            font-size: 1rem;
            color: #333;
            margin-bottom: 8px;
        }

        .product-card .stock-status {
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-family: 'Roboto', sans-serif;
        }

        .product-card .stock-status.instock {
            color: var(--success);
        }

        .product-card .stock-status.outofstock {
            color: var(--danger);
        }

        .product-card .stock-quantity {
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 10px;
            font-family: 'Roboto', sans-serif;
        }

        .low-stock-badge {
            display: inline-block;
            background: red;
            color: #fff;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 500;
            font-family: 'Roboto', sans-serif;
            position: absolute;
            top: 0px;
            right: 50%;
            animation: sway 3s ease-in-out infinite alternate;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            transform-origin: center;
            transition: all 0.5s ease;
        }

        .low-stock-badge:hover {
            animation-play-state: paused;
            transform: scale(1.05);
        }

        @keyframes sway {
            0% { transform: translateX(5px); }
            100% { transform: translateX(95%); }
        }

        .product-card .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .product-card .actions button {
            padding: 8px 16px;
            font-size: 0.9rem;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            font-family: 'Roboto', sans-serif;
        }

        .product-card .actions button:hover {
            background: #1d4ed8;
            transform: scale(1.05);
        }

        .transfer-section {
            display: none;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .transfer-section h2 {
            font-size: 1.6rem;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .transfer-form {
            display: grid;
            gap: 15px;
        }

        .transfer-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .transfer-form select, .transfer-form input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Roboto', sans-serif;
        }

        .transfer-form select:focus, .transfer-form input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .transfer-form button {
            padding: 12px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s, transform 0.2s;
            font-family: 'Roboto', sans-serif;
        }

        .transfer-form button:hover {
            background: #1d4ed8;
            transform: scale(1.02);
        }

        .transfer-form .search-container {
            position: relative;
        }

        .transfer-form .search-container input {
            padding-left: 40px;
        }

        .transfer-form .search-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text);
            font-size: 1rem;
        }

        .transfer-form .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-top: 5px;
            z-index: 10;
            position: relative;
        }

        .transfer-form .search-results .result-item {
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
        }

        .transfer-form .search-results .result-item:hover {
            background: var(--secondary);
        }

        .transfer-form .search-results .no-results {
            padding: 10px;
            color: var(--danger);
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
        }

        .transfer-form .clear-selection {
            padding: 10px;
            background: var(--danger);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s, transform 0.2s;
            font-family: 'Roboto', sans-serif;
            margin-top: 5px;
        }

        .transfer-form .clear-selection:hover {
            background: #b91c1c;
            transform: scale(1.02);
        }

        .transfer-history {
            margin-top: 30px;
            overflow: scroll;
        }

        .transfer-history h3 {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .transfer-history .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .transfer-history .actions button {
            padding: 10px 20px;
            background: var(--danger);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
            font-family: 'Roboto', sans-serif;
        }

        .transfer-history .actions button:hover {
            background: #b91c1c;
        }

        .transfer-history table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
        }

        .transfer-history th, .transfer-history td {
            padding: 12px;
            border: 1px solid var(--border);
            text-align: left;
            font-size: 0.9rem;
            font-family: 'Roboto', sans-serif;
        }

        .transfer-history th {
            background: var(--primary);
            color: #fff;
        }

        .available-stock-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        .available-stock-table th, .available-stock-table td {
            padding: 12px;
            border: 1px solid var(--border);
            text-align: left;
            font-size: 0.9rem;
            font-family: 'Roboto', sans-serif;
        }

        .available-stock-table th {
            background: var(--primary);
            color: #fff;
        }

        .modal, .quick-view-modal, .error-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            transition: opacity 0.3s;
        }

        .modal.active, .quick-view-modal.active, .error-modal.active {
            display: flex;
            opacity: 1;
        }

        .modal-content, .quick-view-content, .error-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }

        .error-content {
            max-width: 400px;
            text-align: center;
        }

        .modal-content h2, .quick-view-content h2 {
            font-size: 1.6rem;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .tabs {
            display: flex;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            font-family: 'Roboto', sans-serif;
        }

        .tab.active {
            background: var(--primary);
            color: #fff;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            background: var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: 'Roboto', sans-serif;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            font-family: 'Roboto', sans-serif;
        }

        .stock-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stock-group span {
            padding: 12px;
            background: var(--secondary);
            border-radius: 8px;
            font-size: 1rem;
            min-width: 80px;
            text-align: center;
            font-family: 'Roboto', sans-serif;
        }

        .stock-group input {
            flex: 1;
            text-align: center;
        }

        .stock-group .stock-btn {
            padding: 10px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.3s, color 0.3s;
        }

        .stock-group .stock-btn:hover {
            background: var(--primary);
            color: #fff;
        }

        .stock-price-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            font-family: 'Roboto', sans-serif;
        }

        .modal-actions .save-btn {
            background: var(--primary);
            color: #fff;
        }

        .modal-actions .save-btn:hover {
            background: #1d4ed8;
            transform: scale(1.02);
        }

        .modal-actions .reset-btn {
            background: var(--warning);
            color: #fff;
        }

        .modal-actions .reset-btn:hover {
            background: #d97706;
            transform: scale(1.02);
        }

        .modal-actions .close-btn, .quick-view-content .close-btn {
            background: var(--danger);
            color: #fff;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .modal-actions .close-btn:hover, .quick-view-content .close-btn:hover {
            background: #b91c1c;
            transform: scale(1.02);
        }

        .quick-view-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .quick-view-content th, .quick-view-content td {
            padding: 12px;
            border: 1px solid var(--border);
            text-align: left;
            font-size: 0.9rem;
            font-family: 'Roboto', sans-serif;
        }

        .quick-view-content th {
            background: var(--primary);
            color: #fff;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            z-index: 2000;
            display: none;
            box-shadow: var(--shadow);
            max-width: 300px;
            align-items: center;
            gap: 10px;
            font-family: 'Roboto', sans-serif;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .loader {
            border: 4px solid var(--secondary);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .filter-bar {
                flex-direction: column;
            }

            .product-card {
                width: 47%;
            }

            .modal-content, .quick-view-content {
                width: 95%;
                padding: 15px;
            }

            .stock-price-group {
                grid-template-columns: 1fr;
            }

            .transfer-form {
                grid-template-columns: 1fr;
            }

            .modal-actions {
                flex-direction: column;
            }

            .filter-tabs button {
                min-width: 130px !important;
                padding: 8px 16px;
                font-size: 0.9rem;
                text-align: center;
            }

            .fab {
                width: 52px;
                height: 52px;
            }

            .transfer-history table {
                font-size: 0.8rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="page-title">Frozen Products</h1>
        </div>
        <div class="products-section" id="products-section">
            <div class="filter-bar">
                <input type="text" id="search" placeholder="Search products or categories...">
            </div>
            <div class="filter-tabs" id="stock-filter"></div>
            <div class="filter-tabs" id="category-filter"></div>
            <div class="filter-tabs" id="warehouse-filter"></div>
            <div class="filter-tabs" id="low-stock-filter" style="display: none;"></div>
            <div id="status-message" class="status-message">Loading products...</div>
            <div id="loader" class="loader"></div>
            <div id="category-sections"></div>
        </div>
        <div class="transfer-section" id="transfer-section">
            <h2>Stock Transfer</h2>
            <div class="transfer-form">
                <div class="form-group">
                    <label><i class="fas fa-box"></i> Select Product</label>
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="transfer-search" placeholder="Search products...">
                    </div>
                    <button class="clear-selection" id="clear-selection">Clear Selection</button>
                    <div id="search-results" class="search-results"></div>
                    <select id="transfer-product" style="display: none;"></select>
                    <div id="available-stock" style="margin-top: 10px;"></div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-warehouse"></i> From Warehouse</label>
                    <select id="transfer-from">
                        <option value="oraby">Oraby</option>
                        <option value="tagamo3">Tagamo3</option>
                        <option value="giza">Giza</option>
                        <option value="lavista">Lavista</option>
                        <option value="manufacturing">Manufacturing</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-warehouse"></i> To Warehouse</label>
                    <select id="transfer-to">
                        <option value="oraby">Oraby</option>
                        <option value="tagamo3">Tagamo3</option>
                        <option value="giza">Giza</option>
                        <option value="lavista">Lavista</option>
                        <option value="manufacturing">Manufacturing</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-hashtag"></i> Quantity</label>
                    <input type="number" id="transfer-quantity" placeholder="Enter quantity" min="1">
                </div>
                <button onclick="transferStock()">Transfer Stock</button>
            </div>
            <div class="transfer-history">
                <h3><i class="fas fa-history"></i> Transfer History</h3>
                <div class="actions">
                    <button onclick="exportHistory()">Export as CSV</button>
                    <button onclick="clearHistory()">Clear All History</button>
                </div>
                <table id="transfer-history-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Quantity</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="fab" id="fab"><i class="fas fa-exchange-alt"></i></div>
    <div class="menu-modal" id="menu-modal">
        <div class="menu-content">
            <h2>Frozen Products</h2>
            <ul>
                <li class="active" data-section="products"><i class="fas fa-box"></i> Products</li>
                <li data-section="transfer"><i class="fas fa-exchange-alt"></i> Transfer</li>
            </ul>
        </div>
    </div>
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <h2 id="edit-product-title">Edit Product</h2>
            <div id="message" class="message"></div>
            <div class="tabs">
                <div class="tab active" data-tab="general">General</div>
                <div class="tab" data-tab="oraby">Oraby</div>
                <div class="tab" data-tab="tagamo3">Tagamo3</div>
                <div class="tab" data-tab="giza">Giza</div>
                <div class="tab" data-tab="lavista">Lavista</div>
                <div class="tab" data-tab="manufacturing">Manufacturing</div>
            </div>
            <div class="tab-content active" id="general-tab">
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Product Name</label>
                    <input type="text" id="name" placeholder="Enter product name">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-language"></i> Arabic Name</label>
                    <input type="text" id="arabic_name" placeholder="Enter Arabic name">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-dollar-sign"></i> Price</label>
                    <input type="number" id="price" step="0.01" placeholder="Enter price">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-check-circle"></i> Stock Status</label>
                    <select id="stock_status">
                        <option value="instock">In Stock</option>
                        <option value="outofstock">Out of Stock</option>
                    </select>
                </div>
            </div>
            <div class="tab-content" id="oraby-tab">
                <div class="stock-price-group">
                    <div class="form-group">
                        <label><i class="fas fa-box"></i> Oraby Stock</label>
                        <div class="stock-group">
                            <span id="current-stock-oraby">0</span>
                            <input type="number" id="adjust-stock-oraby" placeholder="Adjust (+/-)">
                            <button class="stock-btn" onclick="adjustStock('oraby', 1)" title="Increase stock">+</button>
                            <button class="stock-btn" onclick="adjustStock('oraby', -1)" title="Decrease stock">−</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-dollar-sign"></i> Oraby Price</label>
                        <input type="number" id="price-oraby" step="0.01" placeholder="Enter Oraby price">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-exclamation-triangle"></i> Oraby Minimum Stock</label>
                        <input type="number" id="min-stock-oraby" placeholder="Enter minimum stock">
                    </div>
                </div>
            </div>
            <div class="tab-content" id="tagamo3-tab">
                <div class="form-group">
                    <label><i class="fas fa-box"></i> Tagamo3 Stock</label>
                    <div class="stock-group">
                        <span id="current-stock-tagamo3">0</span>
                        <input type="number" id="adjust-stock-tagamo3" placeholder="Adjust (+/-)">
                        <button class="stock-btn" onclick="adjustStock('tagamo3', 1)" title="Increase stock">+</button>
                        <button class="stock-btn" onclick="adjustStock('tagamo3', -1)" title="Decrease stock">−</button>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-dollar-sign"></i> Tagamo3 Price</label>
                    <input type="number" id="price-tagamo3" step="0.01" placeholder="Enter Tagamo3 price">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-exclamation-triangle"></i> Tagamo3 Minimum Stock</label>
                    <input type="number" id="min-stock-tagamo3" placeholder="Enter minimum stock">
                </div>
            </div>
            <div class="tab-content" id="giza-tab">
                <div class="stock-price-group">
                    <div class="form-group">
                        <label><i class="fas fa-box"></i> Giza Stock</label>
                        <div class="stock-group">
                            <span id="current-stock-giza">0</span>
                            <input type="number" id="adjust-stock-giza" placeholder="Adjust (+/-)">
                            <button class="stock-btn" onclick="adjustStock('giza', 1)" title="Increase stock">+</button>
                            <button class="stock-btn" onclick="adjustStock('giza', -1)" title="Decrease stock">−</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-dollar-sign"></i> Giza Price</label>
                        <input type="number" id="price-giza" step="0.01" placeholder="Enter Giza price">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-exclamation-triangle"></i> Giza Minimum Stock</label>
                        <input type="number" id="min-stock-giza" placeholder="Enter minimum stock">
                    </div>
                </div>
            </div>
            <div class="tab-content" id="lavista-tab">
                <div class="stock-price-group">
                    <div class="form-group">
                        <label><i class="fas fa-box"></i> Lavista Stock</label>
                        <div class="stock-group">
                            <span id="current-stock-lavista">0</span>
                            <input type="number" id="adjust-stock-lavista" placeholder="Adjust (+/-)">
                            <button class="stock-btn" onclick="adjustStock('lavista', 1)" title="Increase stock">+</button>
                            <button class="stock-btn" onclick="adjustStock('lavista', -1)" title="Decrease stock">−</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-dollar-sign"></i> Lavista Price</label>
                        <input type="number" id="price-lavista" step="0.01" placeholder="Enter Lavista price">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-exclamation-triangle"></i> Lavista Minimum Stock</label>
                        <input type="number" id="min-stock-lavista" placeholder="Enter minimum stock">
                    </div>
                </div>
            </div>
           
            <div class="tab-content" id="manufacturing-tab">
                <div class="stock-price-group">
                    <div class="form-group">
                        <label><i class="fas fa-box"></i> Manufacturing Stock</label>
                        <div class="stock-group">
                            <span id="current-stock-manufacturing">0</span>
                            <input type="number" id="adjust-stock-manufacturing" placeholder="Adjust (+/-)">
                            <button class="stock-btn" onclick="adjustStock('manufacturing', 1)" title="Increase stock">+</button>
                            <button class="stock-btn" onclick="adjustStock('manufacturing', -1)" title="Decrease stock">−</button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="modal-actions">
                <button class="save-btn" onclick="updateProduct()">Update Product</button>
                <button class="reset-btn" onclick="resetForm()">Reset Fields</button>
                <button class="close-btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
    <div class="quick-view-modal" id="quick-view-modal">
        <div class="quick-view-content">
            <h2>Quick View</h2>
            <div id="quick-view-content"></div>
            <button class="close-btn" onclick="closeQuickView()">Close</button>
        </div>
    </div>
    <div class="error-modal" id="error-modal">
        <div class="error-content">
            <h2><i class="fas fa-exclamation-circle"></i> Error</h2>
            <p id="error-message">An error occurred. Please try again.</p>
            <button class="close-btn" onclick="closeErrorModal()">Close</button>
        </div>
    </div>

    <!-- Navigation Component -->
    <div id="tf-navigation"></div>

    <!-- External Scripts -->
    <script type="text/javascript" src="tf-navigation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Application Logic -->
    <script>
        // API Configuration
        const consumerKey = 'ck_e699cc781f313beee7715ec67e84ab033c19c19b';
        const consumerSecret = 'cs_9e39ce40cfc336a7f547b79c4291f7f322334150';
        const storeUrl = 'https://tenderfrozen.com';
        const apiUrl = `${storeUrl}/wp-json/wc/v3/products`;

        // State
        let products = [];
        let filteredProducts = [];
        let currentProduct = null;
        let currentCategory = 'all';
        let currentStockFilter = 'all';
        let currentWarehouseFilter = 'all';
        let currentLowStockFilter = 'all';
        let transferHistory = JSON.parse(localStorage.getItem('transferHistory')) || [];

        // Utility: Get meta value by key
        function getMetaValue(metaData, key) {
            if (!metaData || !Array.isArray(metaData)) return '';
            const meta = metaData.find(m => m.key === key);
            return meta && meta.value !== undefined ? meta.value : '';
        }

        // Utility: Show toast message
        function showToast(text, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i><span>${text}</span>`;
            document.body.appendChild(toast);
            toast.style.display = 'flex';
            setTimeout(() => {
                toast.style.display = 'none';
                toast.remove();
            }, 3000);
        }

        // Utility: Update status message
        function updateStatusMessage(text) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = text;
        }

        // Utility: Show/hide loader
        function showLoader(show) {
            const loader = document.getElementById('loader');
            loader.style.display = show ? 'block' : 'none';
        }

        // Utility: Show error modal
        function showErrorModal(message) {
            const modal = document.getElementById('error-modal');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            modal.classList.add('active');
        }

        // Close error modal
        function closeErrorModal() {
            const modal = document.getElementById('error-modal');
            modal.classList.remove('active');
        }

        // Fetch products
        async function fetchProducts() {
            showLoader(true);
            updateStatusMessage('Loading products...');
            try {
                const response = await fetch(`${apiUrl}?per_page=100`, {
                    headers: { 'Authorization': 'Basic ' + btoa(`${consumerKey}:${consumerSecret}`) }
                });
                if (!response.ok) throw new Error('Failed to load products');
                products = await response.json();
                filteredProducts = products;
                if (products.length === 0) {
                    updateStatusMessage('No products available.');
                } else {
                    updateStatusMessage('');
                    renderStockFilter();
                    renderCategoryFilter();
                    renderWarehouseFilter();
                    renderLowStockFilter();
                    renderProducts();
                    populateTransferProductSelect();
                }
            } catch (error) {
                console.error('Fetch Products Error:', error);
                updateStatusMessage('Error loading products.');
                showToast('Error fetching products.', 'error');
            } finally {
                showLoader(false);
            }
        }

        // Populate transfer product select
        function populateTransferProductSelect() {
            const transferProduct = document.getElementById('transfer-product');
            transferProduct.innerHTML = '<option value="">Select a product</option>';
            const sortedProducts = [...products].sort((a, b) => 
                (a.name || 'Unnamed Product').localeCompare(b.name || 'Unnamed Product')
            );
            sortedProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name || 'Unnamed Product';
                transferProduct.appendChild(option);
            });
        }

        // Render category filter (buttons)
        function renderCategoryFilter() {
            const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = '';
            const categories = [...new Set(products.flatMap(p => p.categories[1] ? [p.categories[1].name] : []))].filter(c => c.toLowerCase() !== 'uncategorized');
            const allButton = document.createElement('button');
            allButton.innerHTML = '<i class="fas fa-folder"></i> All';
            allButton.dataset.category = 'all';
            allButton.className = currentCategory === 'all' ? 'active' : '';
            allButton.addEventListener('click', () => {
                currentCategory = 'all';
                document.querySelectorAll('#category-filter button').forEach(btn => btn.classList.remove('active'));
                allButton.classList.add('active');
                filterProducts();
            });
            categoryFilter.appendChild(allButton);

            categories.forEach(category => {
                const button = document.createElement('button');
                button.innerHTML = `<i class="fas fa-folder"></i> ${category}`;
                button.dataset.category = category;
                button.className = currentCategory === category ? 'active' : '';
                button.addEventListener('click', () => {
                    currentCategory = category;
                    document.querySelectorAll('#category-filter button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    filterProducts();
                });
                categoryFilter.appendChild(button);
            });
        }

        // Render stock filter (buttons)
        function renderStockFilter() {
            const stockFilter = document.getElementById('stock-filter');
            stockFilter.innerHTML = '';
            const statuses = [
                { value: 'all', label: 'All Status', icon: 'fa-circle' },
                { value: 'instock', label: 'In Stock', icon: 'fa-check-circle' },
                { value: 'outofstock', label: 'Out of Stock', icon: 'fa-times-circle' }
            ];

            statuses.forEach(status => {
                const button = document.createElement('button');
                button.innerHTML = `<i class="fas ${status.icon}"></i> ${status.label}`;
                button.dataset.status = status.value;
                button.className = currentStockFilter === status.value ? 'active' : '';
                button.addEventListener('click', () => {
                    currentStockFilter = status.value;
                    document.querySelectorAll('#stock-filter button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    filterProducts();
                });
                stockFilter.appendChild(button);
            });
        }

        // Render warehouse filter (buttons)
        function renderWarehouseFilter() {
            const warehouseFilter = document.getElementById('warehouse-filter');
            warehouseFilter.innerHTML = '';
            const warehouses = [
                { value: 'all', label: 'All', icon: 'fa-warehouse' },
                { value: 'oraby', label: 'Oraby', icon: 'fa-warehouse' },
                { value: 'tagamo3', label: 'Tagamo3', icon: 'fa-warehouse' },
                { value: 'giza', label: 'Giza', icon: 'fa-warehouse' },
                { value: 'lavista', label: 'Lavista', icon: 'fa-warehouse' },
                { value: 'manufacturing', label: 'Mnufacturing', icon: 'fa-warehouse' }
            ];

            warehouses.forEach(warehouse => {
                const button = document.createElement('button');
                button.innerHTML = `<i class="fas ${warehouse.icon}"></i> ${warehouse.label}`;
                button.dataset.warehouse = warehouse.value;
                button.className = currentWarehouseFilter === warehouse.value ? 'active' : '';
                button.addEventListener('click', () => {
                    currentWarehouseFilter = warehouse.value;
                    document.querySelectorAll('#warehouse-filter button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderLowStockFilter();
                    filterProducts();
                });
                warehouseFilter.appendChild(button);
            });
        }

        // Render low stock filter (buttons)
        function renderLowStockFilter() {
            const lowStockFilter = document.getElementById('low-stock-filter');
            lowStockFilter.innerHTML = '';
            
            if (currentWarehouseFilter === 'all') {
                lowStockFilter.style.display = 'none';
                currentLowStockFilter = 'all';
                return;
            }
            
            lowStockFilter.style.display = 'flex';
            const filters = [
                { value: 'all', label: 'All', icon: 'fa-circle' },
                { value: 'lowstock', label: 'Low Stock', icon: 'fa-exclamation-triangle' }
            ];

            filters.forEach(filter => {
                const button = document.createElement('button');
                button.innerHTML = `<i class="fas ${filter.icon}"></i> ${filter.label}`;
                button.dataset.lowStock = filter.value;
                button.className = currentLowStockFilter === filter.value ? 'active' : '';
                button.addEventListener('click', () => {
                    currentLowStockFilter = filter.value;
                    document.querySelectorAll('#low-stock-filter button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    filterProducts();
                });
                lowStockFilter.appendChild(button);
            });
        }

        // Render products by categories
        function renderProducts() {
    const categorySections = document.getElementById('category-sections');
    categorySections.innerHTML = '';
    
    let filtered = filteredProducts;
    if (currentCategory !== 'all') {
        filtered = filtered.filter(product =>
            product.categories[1]?.name === currentCategory
        );
    }
    if (currentStockFilter !== 'all') {
        if (currentWarehouseFilter === 'all') {
            filtered = filtered.filter(product => product.stock_status === currentStockFilter);
        } else {
            filtered = filtered.filter(product => {
                const stock = parseInt(getMetaValue(product.meta_data, `_stock_${currentWarehouseFilter}`)) || 0;
                return (currentStockFilter === 'instock' && stock > 0) ||
                    (currentStockFilter === 'outofstock' && stock === 0);
            });
        }
    }
    if (currentWarehouseFilter !== 'all' && currentLowStockFilter !== 'all') {
        filtered = filtered.filter(product => {
            const stock = parseInt(getMetaValue(product.meta_data, `_stock_${currentWarehouseFilter}`)) || 0;
            const minStock = parseInt(getMetaValue(product.meta_data, `_min_stock_${currentWarehouseFilter}`)) || 0;
            if (currentLowStockFilter === 'lowstock') {
                return stock > 0 && stock <= minStock;
            } else if (currentLowStockFilter === 'outofstock') {
                return stock === 0;
            }
            return true;
        });
    }
    
    if (filtered.length === 0) {
        updateStatusMessage('No products match your filters.');
        return;
    }
    
    const groupedByCategory = filtered.reduce((acc, product) => {
        const category = product.categories[1]?.name || 'Uncategorized';
        if (!acc[category]) acc[category] = [];
        acc[category].push(product);
        return acc;
    }, {});
    
    Object.keys(groupedByCategory).sort().forEach(category => {
        const section = document.createElement('div');
        section.className = 'category-section';
        section.innerHTML = `<h2><i class="fas fa-folder"></i> ${category}</h2>`;
        const grid = document.createElement('div');
        grid.className = 'product-grid';
        groupedByCategory[category].forEach(product => {
            const card = document.createElement('div');
            const imageSrc = product.images?.[0]?.src || 'https://via.placeholder.com/150?text=No+Image';
            const price = product.regular_price ? `EGP ${parseFloat(product.regular_price).toFixed(2)}` : 'N/A';
            let stockStatus, stockClass, stockDisplay;
            let isOutOfStock = false;
            let isLowStock = false;
            console.log(product);
            if (currentWarehouseFilter === 'all') {
                stockStatus = product.stock_status === 'instock' ? 'In Stock' : 'Out of Stock';
                stockClass = product.stock_status === 'instock' ? 'instock' : 'outofstock';
                const totalStock = ['oraby', 'tagamo3', 'giza', 'lavista', 'manufacturing'].reduce((sum, warehouse) => {
                    return sum + (parseInt(getMetaValue(product.meta_data, `_stock_${warehouse}`)) || 0);
                }, 0);
                stockDisplay = `Total Stock: ${totalStock}`;
                isOutOfStock = totalStock === 0;
            } else {
                const stock = parseInt(getMetaValue(product.meta_data, `_stock_${currentWarehouseFilter}`)) || 0;
                const minStock = parseInt(getMetaValue(product.meta_data, `_min_stock_${currentWarehouseFilter}`)) || 0;
                stockStatus = stock > 0 ? 'In Stock' : 'Out of Stock';
                stockClass = stock > 0 ? 'instock' : 'outofstock';
                stockDisplay = `${currentWarehouseFilter.charAt(0).toUpperCase() + currentWarehouseFilter.slice(1)} Stock: ${stock}`;
                isOutOfStock = stock === 0;
                isLowStock = stock > 0 && stock <= minStock;
            }
            
            const displayName = product.name || 'Unnamed Product';
            card.className = `product-card ${isOutOfStock ? 'out-of-stock' : ''}`;
            card.innerHTML = `
                <img src="${imageSrc}" alt="${displayName}" loading="lazy">
                <h3>${displayName}</h3>
                <p class="price">${price}</p>
                <p class="stock-status ${stockClass}">${stockStatus}</p>
                <p class="stock-quantity">${stockDisplay}</p>
                ${isLowStock ? '<span class="low-stock-badge">Please Re Stock</span>' : ''}
                <div class="actions">
                    <button onclick="openModal(${product.id})">Edit</button>
                    <button onclick="quickView(${product.id})">Quick View</button>
                </div>
            `;
            grid.appendChild(card);
        });
        section.appendChild(grid);
        categorySections.appendChild(section);
    });
}

        // Clear product selection
        function clearProductSelection() {
            const transferProduct = document.getElementById('transfer-product');
            const transferSearch = document.getElementById('transfer-search');
            const availableStockDiv = document.getElementById('available-stock');
            const searchResults = document.getElementById('search-results');

            transferProduct.value = '';
            transferSearch.value = '';
            availableStockDiv.innerHTML = '';
            searchResults.innerHTML = '';
            renderSearchResults('');
        }

        // Render search results for transfer products
        function renderSearchResults(searchTerm = '') {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';

            const sortedProducts = [...products].sort((a, b) => 
                (a.name || 'Unnamed Product').localeCompare(b.name || 'Unnamed Product')
            );

            const filtered = sortedProducts.filter(product =>
                (product.name || 'Unnamed Product').toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filtered.length === 0 && searchTerm) {
                searchResults.innerHTML = '<div class="no-results">No products found</div>';
                return;
            }

            filtered.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.textContent = product.name || 'Unnamed Product';
                resultItem.dataset.productId = product.id;
                resultItem.addEventListener('click', () => {
                    const transferProduct = document.getElementById('transfer-product');
                    const productId = product.id.toString();
                    transferProduct.value = productId;
                    document.getElementById('transfer-search').value = product.name || 'Unnamed Product';
                    renderAvailableStock(productId);
                    searchResults.innerHTML = '';
                });
                searchResults.appendChild(resultItem);
            });
        }

        // Render available stock for selected product
        function renderAvailableStock(productId) {
            const availableStockDiv = document.getElementById('available-stock');
            availableStockDiv.innerHTML = '';

            if (!productId) return;

            const product = products.find(p => p.id == productId);
            if (!product) return;

            const stocks = {
                Oraby: getMetaValue(product.meta_data, '_stock_oraby') || '0',
                Tagamo3: getMetaValue(product.meta_data, '_stock_tagamo3') || '0',
                Giza: getMetaValue(product.meta_data, '_stock_giza') || '0',
                Lavista: getMetaValue(product.meta_data, '_stock_lavista') || '0',
                Manufacturing: getMetaValue(product.meta_data, '_stock_manufacturing') || '0'
            };

            const table = document.createElement('table');
            table.className = 'available-stock-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Warehouse</th>
                        <th>Stock</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Oraby</td><td>${stocks.Oraby}</td></tr>
                    <tr><td>Tagamo3</td><td>${stocks.Tagamo3}</td></tr>
                    <tr><td>Giza</td><td>${stocks.Giza}</td></tr>
                    <tr><td>Lavista</td><td>${stocks.Lavista}</td></tr>
                    <tr><td>Manufacturing</td><td>${stocks.Manufacturing}</td></tr>
                </tbody>
            `;
            availableStockDiv.appendChild(table);
        }

        // Render transfer history
        function renderTransferHistory() {
            const tableBody = document.querySelector('#transfer-history-table tbody');
            tableBody.innerHTML = '';
            transferHistory.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.product}</td>
                    <td>${record.from}</td>
                    <td>${record.to}</td>
                    <td>${record.quantity}</td>
                    <td>${record.date}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Export transfer history as CSV
        function exportHistory() {
            if (transferHistory.length === 0) {
                showToast('No transfer history to export.', 'error');
                return;
            }
            const headers = ['Product,From,To,Quantity,Date'];
            const rows = transferHistory.map(record =>
                `"${record.product}","${record.from}","${record.to}",${record.quantity},"${record.date}"`
            );
            const csv = headers.concat(rows).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transfer_history.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Clear transfer history
        function clearHistory() {
            transferHistory = [];
            localStorage.setItem('transferHistory', JSON.stringify(transferHistory));
            renderTransferHistory();
            showToast('Transfer history cleared.', 'success');
        }

        // Adjust stock
        function adjustStock(warehouse, delta) {
            const input = document.getElementById(`adjust-stock-${warehouse}`);
            const currentValue = parseInt(input.value) || 0;
            input.value = currentValue + delta;
        }

        // Open edit modal
function openModal(productId) {
    currentProduct = products.find(p => p.id === productId);
    if (!currentProduct) return;
    const editModal = document.getElementById('edit-modal');
    const title = document.getElementById('edit-product-title');
    const displayName = currentProduct.name || 'Unnamed Product';
    title.innerHTML = `<i class="fas fa-edit"></i> Edit Product: ${displayName}`;
    editModal.classList.add('active');

    // General tab
    document.getElementById('name').value = currentProduct.name || '';
    document.getElementById('arabic_name').value = getMetaValue(currentProduct.meta_data, '_arabic_name') || '';
    document.getElementById('price').value = currentProduct.regular_price || '';
    document.getElementById('stock_status').value = currentProduct.stock_status || 'instock';

    // Warehouse tabs
    const warehouses = ['oraby', 'tagamo3', 'giza', 'lavista', 'manufacturing'];
    warehouses.forEach(warehouse => {
        const currentStock = getMetaValue(currentProduct.meta_data, `_stock_${warehouse}`) || '0';
        document.getElementById(`current-stock-${warehouse}`).textContent = currentStock;
        document.getElementById(`adjust-stock-${warehouse}`).value = '';
        document.getElementById(`price-${warehouse}`).value = getMetaValue(currentProduct.meta_data, `_price_${warehouse}`) || '';
        document.getElementById(`min-stock-${warehouse}`).value = getMetaValue(currentProduct.meta_data, `_min_stock_${warehouse}`) || '';
    });

    // Reset tabs to show General tab by default
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('.tab[data-tab="general"]').classList.add('active');
    document.getElementById('general-tab').classList.add('active');
}

// Initialize tab switching (move this outside openModal)
document.addEventListener('DOMContentLoaded', () => {
    // Fetch initial data
    fetchProducts();
    renderTransferHistory();

    // Initialize tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
    });

    // Search input listener
    document.getElementById('search').addEventListener('input', () => {
        filterProducts();
    });

    // FAB click to toggle transfer section
    document.getElementById('fab').addEventListener('click', () => {
        const transferSection = document.getElementById('transfer-section');
        const productsSection = document.getElementById('products-section');
        const fab = document.getElementById('fab');
        if (transferSection.style.display === 'none' || !transferSection.style.display) {
            transferSection.style.display = 'block';
            productsSection.style.display = 'none';
            fab.innerHTML = '<i class="fas fa-box"></i>';
            document.querySelector('.menu-modal li[data-section="transfer"]').classList.add('active');
            document.querySelector('.menu-modal li[data-section="products"]').classList.remove('active');
        } else {
            transferSection.style.display = 'none';
            productsSection.style.display = 'block';
            fab.innerHTML = '<i class="fas fa-exchange-alt"></i>';
            document.querySelector('.menu-modal li[data-section="products"]').classList.add('active');
            document.querySelector('.menu-modal li[data-section="transfer"]').classList.remove('active');
        }
    });

    // Menu modal toggle
    document.getElementById('page-title').addEventListener('click', () => {
        const menuModal = document.getElementById('menu-modal');
        menuModal.classList.toggle('active');
    });

    // Menu items click
    document.querySelectorAll('.menu-modal li').forEach(item => {
        item.addEventListener('click', () => {
            const section = item.dataset.section;
            const transferSection = document.getElementById('transfer-section');
            const productsSection = document.getElementById('products-section');
            const fab = document.getElementById('fab');
            document.querySelectorAll('.menu-modal li').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            if (section === 'products') {
                productsSection.style.display = 'block';
                transferSection.style.display = 'none';
                fab.innerHTML = '<i class="fas fa-exchange-alt"></i>';
            } else {
                productsSection.style.display = 'none';
                transferSection.style.display = 'block';
                fab.innerHTML = '<i class="fas fa-box"></i>';
            }
            document.getElementById('menu-modal').classList.remove('active');
        });
    });

    // Transfer search input
    document.getElementById('transfer-search').addEventListener('input', (e) => {
        renderSearchResults(e.target.value);
    });

    // Clear selection button
    document.getElementById('clear-selection').addEventListener('click', clearProductSelection);
});

        // Quick view
        function quickView(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const modal = document.getElementById('quick-view-modal');
            const content = document.getElementById('quick-view-content');
            const price = product.regular_price ? `EGP ${parseFloat(product.regular_price).toFixed(2)}` : 'N/A';
            const stockStatus = product.stock_status === 'instock' ? 'In Stock' : 'Out of Stock';
            const stocks = {
                Oraby: getMetaValue(product.meta_data, '_stock_oraby') || '0',
                Tagamo3: getMetaValue(product.meta_data, '_stock_tagamo3') || '0',
                Giza: getMetaValue(product.meta_data, '_stock_giza') || '0',
                Lavista: getMetaValue(product.meta_data, '_stock_lavista') || '0',
                Manufacturing: getMetaValue(product.meta_data, '_stock_manufacturing') || '0'
            };

            content.innerHTML = `
                <p><strong>Name:</strong> ${product.name || 'Unnamed Product'}</p>
                <p><strong>Price:</strong> ${price}</p>
                <p><strong>Status:</strong> ${stockStatus}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Warehouse</th>
                            <th>Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Oraby</td><td>${stocks.Oraby}</td></tr>
                        <tr><td>Tagamo3</td><td>${stocks.Tagamo3}</td></tr>
                        <tr><td>Giza</td><td>${stocks.Giza}</td></tr>
                        <tr><td>Lavista</td><td>${stocks.Lavista}</td></tr>
                        <tr><td>Mnufacturing</td><td>${stocks.Manufacturing}</td></tr>
                    </tbody>
                </table>
            `;
            modal.classList.add('active');
        }

        // Close quick view
        function closeQuickView() {
            const modal = document.getElementById('quick-view-modal');
            modal.classList.remove('active');
        }

        // Close edit modal
        function closeModal() {
            const editModal = document.getElementById('edit-modal');
            const message = document.getElementById('message');
            editModal.classList.remove('active');
            message.style.display = 'none';
        }

        // Reset form
        function resetForm() {
            if (currentProduct) openModal(currentProduct.id);
        }

        // Update product
        async function updateProduct() {
            if (!currentProduct) {
                showToast('Please select a product.', 'error');
                return;
            }
            
            const inputs = {
                name: document.getElementById('name').value.trim(),
                arabic_name: document.getElementById('arabic_name').value.trim(),
                price: document.getElementById('price').value.trim(),
                stock_status: document.getElementById('stock_status').value,
                adjust_stock_oraby: document.getElementById('adjust-stock-oraby').value.trim(),
                price_oraby: document.getElementById('price-oraby').value.trim(),
                min_stock_oraby: document.getElementById('min-stock-oraby').value.trim(),
                adjust_stock_tagamo3: document.getElementById('adjust-stock-tagamo3').value.trim(),
                price_tagamo3: document.getElementById('price-tagamo3').value.trim(),
                min_stock_tagamo3: document.getElementById('min-stock-tagamo3').value.trim(),
                adjust_stock_giza: document.getElementById('adjust-stock-giza').value.trim(),
                price_giza: document.getElementById('price-giza').value.trim(),
                min_stock_giza: document.getElementById('min-stock-giza').value.trim(),
                adjust_stock_lavista: document.getElementById('adjust-stock-lavista').value.trim(),
                price_lavista: document.getElementById('price-lavista').value.trim(),
                min_stock_lavista: document.getElementById('min-stock-lavista').value.trim(),
                adjust_stock_manufacturing: document.getElementById('adjust-stock-manufacturing').value.trim(),
                price_manufacturing: document.getElementById('price-manufacturing').value.trim(),
                min_stock_manufacturing: document.getElementById('min-stock-manufacturing').value.trim()
            };
            
            if (!inputs.name) {
                showToast('Product name is required.', 'error');
                return;
            }
            
            const warehouses = ['oraby', 'tagamo3', 'giza', 'lavista', 'manufacturing'];
            for (const warehouse of warehouses) {
                const adjustStock = parseInt(inputs[`adjust_stock_${warehouse}`]) || 0;
                const currentStock = parseInt(getMetaValue(currentProduct.meta_data, `_stock_${warehouse}`)) || 0;
                if (currentStock + adjustStock < 0) {
                    showToast(`Cannot reduce ${warehouse} stock below 0.`, 'error');
                    return;
                }
            }
            
            // Prepare data for update
            const data = {
                meta_data: []
            };
            
            // Update name only if changed
            if (inputs.name !== currentProduct.name) {
                data.name = inputs.name;
            }
            
            // Update stock status only if changed
            if (inputs.stock_status !== currentProduct.stock_status) {
                data.stock_status = inputs.stock_status;
            }
            
            // Always include the current regular_price to prevent server-side overrides
            const currentRegularPrice = currentProduct.regular_price ? currentProduct.regular_price.toString() : '';
            data.regular_price = currentRegularPrice;
            
            // Update regular_price only if explicitly changed
            if (inputs.price !== '' && inputs.price !== currentRegularPrice) {
                const newPrice = parseFloat(inputs.price);
                if (!isNaN(newPrice) && newPrice >= 0) {
                    data.regular_price = newPrice.toString();
                } else {
                    showToast('Invalid price format for regular price.', 'error');
                    return;
                }
            }
            
            // Update Arabic Name (Separate Request)
            const currentArabicName = getMetaValue(currentProduct.meta_data, '_arabic_name') || '';
            if (inputs.arabic_name !== currentArabicName) {
                showLoader(true);
                try {
                    const arabicNameData = {
                        meta_data: [{
                            key: '_arabic_name',
                            value: inputs.arabic_name
                        }]
                    };
                    console.log('Sending Arabic name update:', JSON.stringify(arabicNameData, null, 2));
                    const response = await fetch(`${apiUrl}/${currentProduct.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': 'Basic ' + btoa(`${consumerKey}:${consumerSecret}`),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(arabicNameData)
                    });
                    
                    const responseData = await response.json();
                    console.log('Arabic name update response:', JSON.stringify(responseData, null, 2));
                    
                    if (!response.ok) {
                        showErrorModal(`Failed to update Arabic name: ${responseData.message || 'Unknown error'}`);
                        showLoader(false);
                        return;
                    }
                } catch (error) {
                    showErrorModal('Failed to update Arabic name due to a network or server error.');
                    console.error('Arabic Name Update Error:', error);
                    showLoader(false);
                    return;
                }
            }
            
            // Update warehouse-specific data
            warehouses.forEach(warehouse => {
                const adjustStock = parseInt(inputs[`adjust_stock_${warehouse}`]) || 0;
                const currentStock = parseInt(getMetaValue(currentProduct.meta_data, `_stock_${warehouse}`)) || 0;
                const currentWarehousePrice = getMetaValue(currentProduct.meta_data, `_price_${warehouse}`) || '';
                const currentMinStock = getMetaValue(currentProduct.meta_data, `_min_stock_${warehouse}`) || '';
                
                // Update stock if there's an adjustment
                if (adjustStock !== 0) {
                    data.meta_data.push({
                        key: `_stock_${warehouse}`,
                        value: (currentStock + adjustStock).toString()
                    });
                }
                
                // Update warehouse price only if a new, different value is provided
                if (inputs[`price_${warehouse}`] !== '' && inputs[`price_${warehouse}`] !== currentWarehousePrice) {
                    const newPrice = parseFloat(inputs[`price_${warehouse}`]);
                    if (!isNaN(newPrice) && newPrice >= 0) {
                        data.meta_data.push({
                            key: `_price_${warehouse}`,
                            value: newPrice.toString()
                        });
                    } else {
                        showToast(`Invalid price format for ${warehouse}.`, 'error');
                        return;
                    }
                }
                
                // Update minimum stock if a new, different value is provided
                if (inputs[`min_stock_${warehouse}`] !== '' && inputs[`min_stock_${warehouse}`] !== currentMinStock) {
                    const newMinStock = parseInt(inputs[`min_stock_${warehouse}`]);
                    if (!isNaN(newMinStock) && newMinStock >= 0) {
                        data.meta_data.push({
                            key: `_min_stock_${warehouse}`,
                            value: newMinStock.toString()
                        });
                    } else {
                        showToast(`Invalid minimum stock format for ${warehouse}.`, 'error');
                        return;
                    }
                }
            });
            
            // Log the data being sent for debugging
            console.log('Data to be sent to API:', JSON.stringify(data, null, 2));
            
            // Only send the update request if there are changes to apply
            if (data.name || data.stock_status || data.regular_price || data.meta_data.length > 0) {
                showLoader(true);
                try {
                    const response = await fetch(`${apiUrl}/${currentProduct.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic ' + btoa(`${consumerKey}:${consumerSecret}`)
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const responseData = await response.json();
                    console.log('API response:', JSON.stringify(responseData, null, 2));
                    
                    if (response.ok) {
                        showToast('Product updated successfully!', 'success');
                        await fetchProducts();
                        closeModal();
                    } else {
                        showErrorModal(`Failed to update product: ${responseData.message || 'Unknown error'}`);
                        console.error('API Error:', responseData);
                    }
                } catch (error) {
                    showErrorModal('Failed to update product due to a network or server error.');
                    console.error('Update Error:', error);
                } finally {
                    showLoader(false);
                }
            } else {
                showToast('No changes to update.', 'success');
                closeModal();
            }
        }

        // Transfer stock
        async function transferStock() {
            const transferProduct = document.getElementById('transfer-product');
            const productId = transferProduct.value;
            const fromWarehouse = document.getElementById('transfer-from').value;
            const toWarehouse = document.getElementById('transfer-to').value;
            const quantityInput = document.getElementById('transfer-quantity').value;

            const parsedProductId = parseInt(productId);
            if (!productId || isNaN(parsedProductId)) {
                showToast('Please select a product from the list.', 'error');
                return;
            }

            if (!fromWarehouse) {
                showToast('Please select a source warehouse.', 'error');
                return;
            }

            if (!toWarehouse) {
                showToast('Please select a destination warehouse.', 'error');
                return;
            }

            if (fromWarehouse === toWarehouse) {
                showToast('Source and destination warehouses cannot be the same.', 'error');
                return;
            }

            const quantity = parseInt(quantityInput);
            if (isNaN(quantity) || quantity <= 0) {
                showToast('Please enter a valid quantity greater than zero.', 'error');
                return;
            }

            const product = products.find(p => p.id === parsedProductId);
            if (!product) {
                showToast('Selected product not found.', 'error');
                return;
            }

            const fromStock = parseInt(getMetaValue(product.meta_data, `_stock_${fromWarehouse}`)) || 0;
            if (fromStock < quantity) {
                showToast(`Insufficient stock in ${fromWarehouse}. Available: ${fromStock} units.`, 'error');
                return;
            }

            const updatedMeta = product.meta_data ? [...product.meta_data] : [];
            const fromMetaIndex = updatedMeta.findIndex(m => m.key === `_stock_${fromWarehouse}`);
            const toMetaIndex = updatedMeta.findIndex(m => m.key === `_stock_${toWarehouse}`);

            if (fromMetaIndex >= 0) {
                updatedMeta[fromMetaIndex].value = (fromStock - quantity).toString();
            } else {
                updatedMeta.push({ key: `_stock_${fromWarehouse}`, value: (fromStock - quantity).toString() });
            }

            const toStock = parseInt(getMetaValue(product.meta_data, `_stock_${toWarehouse}`)) || 0;
            if (toMetaIndex >= 0) {
                updatedMeta[toMetaIndex].value = (toStock + quantity).toString();
            } else {
                updatedMeta.push({ key: `_stock_${toWarehouse}`, value: (toStock + quantity).toString() });
            }

            const data = { meta_data: updatedMeta };

            showLoader(true);
            try {
                const response = await fetch(`${apiUrl}/${parsedProductId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa(`${consumerKey}:${consumerSecret}`)
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast(`Successfully transferred ${quantity} units from ${fromWarehouse} to ${toWarehouse}.`, 'success');
                    await fetchProducts();
                    const displayName = product.name || 'Unnamed Product';
                    const record = {
                        product: displayName,
                        from: fromWarehouse,
                        to: toWarehouse,
                        quantity,
                        date: new Date().toLocaleString()
                    };
                    transferHistory.push(record);
                    localStorage.setItem('transferHistory', JSON.stringify(transferHistory));
                    renderTransferHistory();
                    document.getElementById('transfer-quantity').value = '';
                    clearProductSelection();
                } else {
                    const error = await response.json();
                    showErrorModal(`Failed to transfer stock: ${error.message || 'Unknown error'}`);
                }
            } catch (error) {
                showErrorModal('Failed to transfer stock due to a network or server error.');
            } finally {
                showLoader(false);
            }
        }

        // Filter products
        function filterProducts() {
            let searchTerm = document.getElementById('search').value.toLowerCase();
            filteredProducts = products.filter(product => {
                const name = (product.name || 'Unnamed Product').toLowerCase();
                const categories = product.categories.map(c => c.name.toLowerCase());
                const matchesSearch = name.includes(searchTerm) ||
                    categories.some(c => c.includes(searchTerm));
                const matchesCategory = currentCategory === 'all' || product.categories.some(c => c.name === currentCategory);
                let matchesStock = true;
                let matchesLowStock = true;
                
                if (currentStockFilter !== 'all') {
                    if (currentWarehouseFilter === 'all') {
                        matchesStock = product.stock_status === currentStockFilter;
                    } else {
                        const stock = parseInt(getMetaValue(product.meta_data, `_stock_${currentWarehouseFilter}`)) || 0;
                        matchesStock = (currentStockFilter === 'instock' && stock > 0) ||
                            (currentStockFilter === 'outofstock' && stock === 0);
                    }
                }
                
                if (currentWarehouseFilter !== 'all' && currentLowStockFilter === 'lowstock') {
                    const stock = parseInt(getMetaValue(product.meta_data, `_stock_${currentWarehouseFilter}`)) || 0;
                    const minStock = parseInt(getMetaValue(product.meta_data, `_min_stock_${currentWarehouseFilter}`)) || 0;
                    matchesLowStock = stock > 0 && stock <= minStock;
                }
                
                return matchesSearch && matchesCategory && matchesStock && matchesLowStock;
            });

            renderProducts();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch initial data
            fetchProducts();
            renderTransferHistory();

            // Search input listener
            document.getElementById('search').addEventListener('input', () => {
                filterProducts();
            });

            document.getElementById('fab').addEventListener('click', () => {
    const transferSection = document.getElementById('transfer-section');
    const productsSection = document.getElementById('products-section');
    const fab = document.getElementById('fab');

    // التأكد من وجود العناصر
    if (!transferSection || !productsSection || !fab) {
        console.error('One or more elements not found');
        return;
    }


    if (transferSection.style.display === 'none') {
        transferSection.style.display = 'block !important';
        productsSection.style.display = 'none  !important';
        fab.innerHTML = '<i class="fas fa-box"></i>';
        document.querySelector('#transfer-section').classList.add('active');
        document.querySelector('#products-section').classList.remove('active');
        console.log('Current transfer section display:', transferDisplay);
    } else {
        console.log('Showing products section');
        transferSection.style.display = 'none !important';
        productsSection.style.display = 'block !important';
        fab.innerHTML = '<i class="fas fa-exchange-alt"></i>';
        document.querySelector('.menu-modal li[data-section="products"]').classList.add('active');
        document.querySelector('.menu-modal li[data-section="transfer"]').classList.remove('active');
    }
});

            // Menu modal toggle
            document.getElementById('page-title').addEventListener('click', () => {
                const menuModal = document.getElementById('menu-modal');
                menuModal.classList.toggle('active');
            });

            // Menu items click
            document.querySelectorAll('.menu-modal li').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    const transferSection = document.getElementById('transfer-section');
                    const productsSection = document.getElementById('products-section');
                    const fab = document.getElementById('fab');
                    document.querySelectorAll('.menu-modal li').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    if (section === 'products') {
                        productsSection.style.display = 'block';
                        transferSection.style.display = 'none';
                        fab.innerHTML = '<i class="fas fa-exchange-alt"></i>';
                    } else {
                        productsSection.style.display = 'none';
                        transferSection.style.display = 'block';
                        fab.innerHTML = '<i class="fas fa-box"></i>';
                    }
                    document.getElementById('menu-modal').classList.remove('active');
                });
            });

            // Transfer search input
            document.getElementById('transfer-search').addEventListener('input', (e) => {
                renderSearchResults(e.target.value);
            });

            // Clear selection button
            document.getElementById('clear-selection').addEventListener('click', clearProductSelection);
        });


        
        
        
    </script>
</body>
</html>
